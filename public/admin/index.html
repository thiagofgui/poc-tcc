<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema QR Code</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .back-btn { background: #6c757d; margin-bottom: 20px; }
        .back-btn:hover { background: #545b62; }
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 800px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Admin -->
        <div id="loginSection" class="section">
            <button onclick="window.location.href='/'" class="back-btn">← Voltar</button>
            <h1>Login do Administrador</h1>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label>Usuário:</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label>Senha:</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit">Entrar</button>
            </form>
        </div>

        <!-- Dashboard Admin -->
        <div id="dashboardSection" class="hidden" style="display: none;">
            <div class="header">
                <h1>Painel Administrativo</h1>
            </div>

        <!-- Cadastro de Prédios -->
        <div class="section">
            <h2>Cadastrar Prédio</h2>
            <form id="buildingForm">
                <div class="form-group">
                    <label>Nome do Prédio:</label>
                    <input type="text" id="buildingName" required>
                </div>
                <div class="form-group">
                    <label>Endereço:</label>
                    <input type="text" id="buildingAddress" required>
                </div>
                <div class="form-group">
                    <label>ID do Tenant:</label>
                    <input type="text" id="tenantId" required>
                </div>
                <button type="submit">Cadastrar Prédio</button>
            </form>
        </div>

        <!-- Lista de Prédios -->
        <div class="section">
            <h2>Prédios Cadastrados</h2>
            <table id="buildingsTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Endereço</th>
                        <th>Tenant ID</th>
                        <th>Status</th>
                        <th>Catracas</th>
                        <th>Moradores</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button onclick="logout()" style="background: #dc3545; margin-top: 20px;" class="hidden" id="logoutBtn">Sair</button>
        </div>
        
        <!-- Modal de Catracas -->
        <div id="turnstileModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeTurnstileModal()">&times;</span>
                <h2 id="modalTitle">Gerenciar Catracas</h2>
                
                <!-- Cadastro de Catraca -->
                <div class="section">
                    <h3>Cadastrar Nova Catraca</h3>
                    <form id="turnstileForm">
                        <div class="form-group">
                            <label>Nome da Catraca:</label>
                            <input type="text" id="turnstileName" required>
                        </div>
                        <button type="submit">Cadastrar Catraca</button>
                    </form>
                </div>
                
                <!-- Lista de Catracas -->
                <div class="section">
                    <h3>Catracas Cadastradas</h3>
                    <table id="turnstileTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal de Edição de Prédio -->
        <div id="editBuildingModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditBuildingModal()">&times;</span>
                <h2>Editar Prédio</h2>
                <form id="editBuildingForm">
                    <input type="hidden" id="editBuildingId">
                    <div class="form-group">
                        <label>Nome do Prédio:</label>
                        <input type="text" id="editBuildingName" required>
                    </div>
                    <div class="form-group">
                        <label>Endereço:</label>
                        <input type="text" id="editBuildingAddress" required>
                    </div>
                    <div class="form-group">
                        <label>ID do Tenant:</label>
                        <input type="text" id="editTenantId" required>
                    </div>
                    <button type="submit">Salvar Alterações</button>
                </form>
            </div>
        </div>
        
        <!-- Modal de Edição de Morador -->
        <div id="editResidentModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditResidentModal()">&times;</span>
                <h2>Editar Morador</h2>
                <form id="editResidentForm">
                    <input type="hidden" id="editResidentId">
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="editResidentName" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="editResidentEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Apartamento:</label>
                        <input type="text" id="editApartment" required>
                    </div>
                    <div class="form-group">
                        <label>Prédio:</label>
                        <select id="editBuildingSelect" required>
                            <option value="">Selecione um prédio</option>
                        </select>
                    </div>
                    <button type="submit">Salvar Alterações</button>
                </form>
            </div>
        </div>
        
        <!-- Modal de QR Codes do Morador -->
        <div id="qrCodesModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeQRCodesModal()">&times;</span>
                <h2 id="qrCodesModalTitle">QR Codes Ativos</h2>
                <div id="qrCodesList"></div>
            </div>
        </div>
        
        <!-- Modal de Moradores do Prédio -->
        <div id="residentsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeResidentsModal()">&times;</span>
                <h2 id="residentsModalTitle">Gerenciar Moradores</h2>
                
                <!-- Cadastro de Morador -->
                <div class="section">
                    <h3>Cadastrar Novo Morador</h3>
                    <form id="residentForm">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="residentName" required>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="residentEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" id="residentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>Apartamento:</label>
                            <input type="text" id="apartment" required>
                        </div>
                        <button type="submit">Cadastrar Morador</button>
                    </form>
                </div>
                
                <!-- Lista de Moradores do Prédio -->
                <div class="section">
                    <h3>Moradores Cadastrados</h3>
                    <table id="buildingResidentsTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Apartamento</th>
                                <th>Status</th>
                                <th>QR Codes</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        
        // Verificar se já está logado
        document.addEventListener('DOMContentLoaded', function() {
            if (adminToken) {
                showDashboard();
            }
        });
        
        // Login Admin
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                username: document.getElementById('adminUsername').value,
                password: document.getElementById('adminPassword').value
            };

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    adminToken = result.token;
                    localStorage.setItem('adminToken', adminToken);
                    showDashboard();
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            loadBuildings();
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        // Cadastrar prédio
        document.getElementById('buildingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('buildingName').value,
                address: document.getElementById('buildingAddress').value,
                tenantId: document.getElementById('tenantId').value
            };

            try {
                const response = await fetch('/api/admin/buildings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Prédio cadastrado com sucesso!');
                    document.getElementById('buildingForm').reset();
                    loadBuildings();
                } else {
                    alert('Erro ao cadastrar prédio');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });

        // Gerenciar moradores do prédio
        let currentBuildingIdForResidents = null;
        
        function manageResidents(buildingId, buildingName) {
            currentBuildingIdForResidents = buildingId;
            document.getElementById('residentsModalTitle').textContent = `Moradores - ${buildingName}`;
            document.getElementById('residentsModal').style.display = 'block';
            loadBuildingResidents();
        }
        
        function closeResidentsModal() {
            document.getElementById('residentsModal').style.display = 'none';
            currentBuildingIdForResidents = null;
        }
        
        // Cadastrar morador no prédio atual
        document.getElementById('residentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentBuildingIdForResidents) {
                alert('Erro: Nenhum prédio selecionado');
                return;
            }
            
            const data = {
                name: document.getElementById('residentName').value,
                email: document.getElementById('residentEmail').value,
                password: document.getElementById('residentPassword').value,
                apartment: document.getElementById('apartment').value,
                buildingId: currentBuildingIdForResidents
            };

            try {
                const response = await fetch('/api/admin/residents', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Morador cadastrado com sucesso!');
                    document.getElementById('residentForm').reset();
                    loadBuildingResidents();
                } else {
                    alert('Erro ao cadastrar morador');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });

        // Carregar prédios
        async function loadBuildings() {
            try {
                const response = await fetch('/api/admin/buildings', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const buildings = await response.json();
                
                const tbody = document.querySelector('#buildingsTable tbody');
                tbody.innerHTML = '';
                
                buildings.forEach(building => {
                    // Tabela
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${building.name}</td>
                        <td>${building.address}</td>
                        <td>${building.tenantId}</td>
                        <td>
                            <span style="color: ${building.isActive !== false ? '#28a745' : '#dc3545'}">
                                ${building.isActive !== false ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button onclick="manageTurnstiles('${building._id}', '${building.name}')">Gerenciar</button>
                        </td>
                        <td>
                            <button onclick="manageResidents('${building._id}', '${building.name}')" style="background: #17a2b8;">Gerenciar</button>
                        </td>
                        <td>
                            <button onclick="editBuilding('${building._id}', '${building.name}', '${building.address}', '${building.tenantId}', ${building.isActive !== false})" style="background: #ffc107; color: #212529;">Editar</button>
                            <button onclick="toggleBuildingStatus('${building._id}', ${building.isActive !== false})" style="background: ${building.isActive !== false ? '#dc3545' : '#28a745'}; margin-left: 5px;">
                                ${building.isActive !== false ? 'Desativar' : 'Ativar'}
                            </button>
                        </td>
                    `;
                    

                });
            } catch (error) {
                console.error('Erro ao carregar prédios:', error);
            }
        }

        // Carregar moradores do prédio atual
        async function loadBuildingResidents() {
            if (!currentBuildingIdForResidents) return;
            
            try {
                const response = await fetch(`/api/admin/buildings/${currentBuildingIdForResidents}/residents`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const residents = await response.json();
                const tbody = document.querySelector('#buildingResidentsTable tbody');
                tbody.innerHTML = '';
                
                if (response.ok && residents.length > 0) {
                    residents.forEach(resident => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${resident.name}</td>
                            <td>${resident.email}</td>
                            <td>${resident.apartment}</td>
                            <td>
                                <span style="color: ${resident.isActive !== false ? '#28a745' : '#dc3545'}">
                                    ${resident.isActive !== false ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td>
                                <button onclick="showQRCodesInline('${resident._id}', '${resident.name}')" style="background: #17a2b8; font-size: 12px; padding: 5px 10px;">Ver QR Codes</button>
                            </td>
                            <td>
                                <button onclick="editBuildingResident('${resident._id}', '${resident.name}', '${resident.email}', '${resident.apartment}', ${resident.isActive !== false})" style="background: #ffc107; color: #212529; font-size: 12px; padding: 5px 10px;">Editar</button>
                                <button onclick="toggleResidentStatus('${resident._id}', ${resident.isActive !== false})" style="background: ${resident.isActive !== false ? '#dc3545' : '#28a745'}; font-size: 12px; padding: 5px 10px; margin-left: 5px;">
                                    ${resident.isActive !== false ? 'Desativar' : 'Ativar'}
                                </button>
                            </td>
                        `;
                    });
                } else {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td colspan="6" style="text-align: center; color: #666;">Nenhum morador cadastrado</td>';
                }
            } catch (error) {
                console.error('Erro ao carregar moradores:', error);
            }
        }

        // Excluir prédio
        async function deleteBuilding(id) {
            if (confirm('Tem certeza que deseja excluir este prédio?')) {
                try {
                    const response = await fetch(`/api/admin/buildings/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });
                    
                    if (response.ok) {
                        alert('Prédio excluído com sucesso!');
                        loadBuildings();
                    } else {
                        alert('Erro ao excluir prédio');
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        // Gerenciar catracas
        let currentBuildingId = null;
        
        function manageTurnstiles(buildingId, buildingName) {
            currentBuildingId = buildingId;
            document.getElementById('modalTitle').textContent = `Catracas - ${buildingName}`;
            document.getElementById('turnstileModal').style.display = 'block';
            loadTurnstiles();
        }
        
        function closeTurnstileModal() {
            document.getElementById('turnstileModal').style.display = 'none';
            currentBuildingId = null;
        }
        
        // Fechar modal clicando fora
        window.onclick = function(event) {
            const modal = document.getElementById('turnstileModal');
            if (event.target === modal) {
                closeTurnstileModal();
            }
        }
        
        // Cadastrar catraca
        document.getElementById('turnstileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('turnstileName').value
            };

            try {
                const response = await fetch(`/api/admin/buildings/${currentBuildingId}/turnstiles`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    // Criar configuração da catraca no Turnstile Service
                    try {
                        await fetch(`${window.location.origin.replace('3002', '3031')}/turnstile/config`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                gate: result.id,
                                name: result.name,
                                isActive: true
                            })
                        });
                    } catch (configError) {
                        console.warn('Erro ao criar configuração da catraca:', configError);
                    }
                    
                    alert('Catraca cadastrada com sucesso!');
                    document.getElementById('turnstileForm').reset();
                    loadTurnstiles();
                } else {
                    alert('Erro ao cadastrar catraca');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });
        
        // Carregar catracas
        async function loadTurnstiles() {
            if (!currentBuildingId) return;
            
            try {
                const response = await fetch(`/api/admin/buildings/${currentBuildingId}/turnstiles`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const turnstiles = await response.json();
                const tbody = document.querySelector('#turnstileTable tbody');
                tbody.innerHTML = '';
                
                if (response.ok && turnstiles.length > 0) {
                    turnstiles.forEach(turnstile => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${turnstile.id}</td>
                            <td>${turnstile.name}</td>
                            <td>
                                <span style="color: ${turnstile.isActive !== false ? '#28a745' : '#dc3545'}">
                                    ${turnstile.isActive !== false ? 'Ativa' : 'Inativa'}
                                </span>
                            </td>
                            <td>
                                <button onclick="editTurnstile('${turnstile.id}', '${turnstile.name}', ${turnstile.isActive !== false})" style="background: #ffc107; color: #212529; font-size: 12px; padding: 5px 10px;">Editar</button>
                                <button onclick="toggleTurnstileStatus('${turnstile.id}', ${turnstile.isActive !== false})" style="background: ${turnstile.isActive !== false ? '#dc3545' : '#28a745'}; font-size: 12px; padding: 5px 10px; margin-left: 5px;">
                                    ${turnstile.isActive !== false ? 'Desativar' : 'Ativar'}
                                </button>
                            </td>
                        `;
                    });
                } else {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">Nenhuma catraca cadastrada</td>';
                }
            } catch (error) {
                console.error('Erro ao carregar catracas:', error);
            }
        }
        
        // Funções de Edição de Prédio
        function editBuilding(id, name, address, tenantId, isActive) {
            document.getElementById('editBuildingId').value = id;
            document.getElementById('editBuildingName').value = name;
            document.getElementById('editBuildingAddress').value = address;
            document.getElementById('editTenantId').value = tenantId;
            document.getElementById('editBuildingModal').style.display = 'block';
        }
        
        function closeEditBuildingModal() {
            document.getElementById('editBuildingModal').style.display = 'none';
        }
        
        document.getElementById('editBuildingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editBuildingId').value;
            const data = {
                name: document.getElementById('editBuildingName').value,
                address: document.getElementById('editBuildingAddress').value,
                tenantId: document.getElementById('editTenantId').value
            };

            try {
                const response = await fetch(`/api/admin/buildings/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Prédio atualizado com sucesso!');
                    closeEditBuildingModal();
                    loadBuildings();
                } else {
                    alert('Erro ao atualizar prédio');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });
        
        async function toggleBuildingStatus(id, currentStatus) {
            const action = currentStatus ? 'desativar' : 'ativar';
            if (confirm(`Tem certeza que deseja ${action} este prédio?`)) {
                try {
                    const response = await fetch(`/api/admin/buildings/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ isActive: !currentStatus })
                    });

                    if (response.ok) {
                        alert(`Prédio ${currentStatus ? 'desativado' : 'ativado'} com sucesso!`);
                        loadBuildings();
                    } else {
                        alert(`Erro ao ${action} prédio`);
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        // Funções de Edição de Morador do Prédio
        function editBuildingResident(id, name, email, apartment, isActive) {
            document.getElementById('editResidentId').value = id;
            document.getElementById('editResidentName').value = name;
            document.getElementById('editResidentEmail').value = email;
            document.getElementById('editApartment').value = apartment;
            
            // Definir o prédio atual automaticamente
            const select = document.getElementById('editBuildingSelect');
            select.innerHTML = `<option value="${currentBuildingIdForResidents}" selected>Prédio Atual</option>`;
            
            document.getElementById('editResidentModal').style.display = 'block';
        }
        
        function closeEditResidentModal() {
            document.getElementById('editResidentModal').style.display = 'none';
        }
        
        document.getElementById('editResidentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editResidentId').value;
            const data = {
                name: document.getElementById('editResidentName').value,
                email: document.getElementById('editResidentEmail').value,
                apartment: document.getElementById('editApartment').value,
                buildingId: currentBuildingIdForResidents || document.getElementById('editBuildingSelect').value
            };

            try {
                const response = await fetch(`/api/admin/residents/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Morador atualizado com sucesso!');
                    closeEditResidentModal();
                    if (currentBuildingIdForResidents) {
                        loadBuildingResidents();
                    }
                } else {
                    alert('Erro ao atualizar morador');
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });
        
        async function toggleResidentStatus(id, currentStatus) {
            const action = currentStatus ? 'desativar' : 'ativar';
            if (confirm(`Tem certeza que deseja ${action} este morador?`)) {
                try {
                    const response = await fetch(`/api/admin/residents/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ isActive: !currentStatus })
                    });

                    if (response.ok) {
                        alert(`Morador ${currentStatus ? 'desativado' : 'ativado'} com sucesso!`);
                        if (currentBuildingIdForResidents) {
                            loadBuildingResidents();
                        }
                    } else {
                        alert(`Erro ao ${action} morador`);
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        // Mostrar QR Codes inline no modal de moradores
        async function showQRCodesInline(residentId, residentName) {
            const row = event.target.closest('tr');
            let qrRow = row.nextElementSibling;
            
            // Se já existe uma linha de QR Codes, remove
            if (qrRow && qrRow.classList.contains('qr-codes-row')) {
                qrRow.remove();
                return;
            }
            
            // Criar nova linha para QR Codes
            qrRow = document.createElement('tr');
            qrRow.classList.add('qr-codes-row');
            qrRow.innerHTML = '<td colspan="6" style="padding: 0; background: #f8f9fa;"><div id="qr-inline-' + residentId + '" style="padding: 15px;">Carregando QR Codes...</div></td>';
            
            row.parentNode.insertBefore(qrRow, row.nextSibling);
            
            try {
                const response = await fetch(`/api/admin/residents/${residentId}/qrcodes`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const qrCodes = await response.json();
                const container = document.getElementById('qr-inline-' + residentId);
                
                if (response.ok && qrCodes.length > 0) {
                    let html = `<h4 style="margin: 0 0 10px 0; color: #333;">QR Codes Ativos - ${residentName}</h4>`;
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr style="background: #e9ecef;"><th style="padding: 8px;">Visitante</th><th style="padding: 8px;">Válido Até</th><th style="padding: 8px;">Usos</th><th style="padding: 8px;">Status</th><th style="padding: 8px;">Ações</th></tr></thead><tbody>';
                    
                    qrCodes.forEach(qr => {
                        const expiresAt = new Date(qr.windowEnd).toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'});
                        const statusColor = qr.status === 'ACTIVE' ? '#28a745' : qr.status === 'PENDING' ? '#ffc107' : '#dc3545';
                        
                        html += `
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px;">${qr.visitName}</td>
                                <td style="padding: 8px;">${expiresAt}</td>
                                <td style="padding: 8px;">${qr.usedCount}/${qr.maxUses}</td>
                                <td style="padding: 8px; color: ${statusColor};">${qr.status}</td>
                                <td style="padding: 8px;">
                                    <button onclick="revokeQRCode('${qr.jti}')" class="btn-danger" style="font-size: 10px; padding: 3px 8px;">Revogar</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<h4 style="margin: 0 0 10px 0; color: #333;">QR Codes Ativos - ${residentName}</h4><p style="text-align: center; color: #666; margin: 0;">Nenhum QR Code ativo encontrado</p>`;
                }
            } catch (error) {
                document.getElementById('qr-inline-' + residentId).innerHTML = `<h4 style="margin: 0 0 10px 0; color: #333;">QR Codes Ativos - ${residentName}</h4><p style="text-align: center; color: #dc3545; margin: 0;">Erro ao carregar QR Codes</p>`;
            }
        }
        
        function closeQRCodesModal() {
            document.getElementById('qrCodesModal').style.display = 'none';
        }
        
        async function revokeQRCode(jti) {
            if (confirm('Tem certeza que deseja revogar este QR Code?')) {
                try {
                    const response = await fetch(`/api/admin/qrcodes/${jti}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });

                    if (response.ok) {
                        alert('QR Code revogado com sucesso!');
                        // Recarregar moradores do prédio para atualizar QR Codes
                        if (currentBuildingIdForResidents) {
                            loadBuildingResidents();
                        }
                    } else {
                        alert('Erro ao revogar QR Code');
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        // Funções de Catraca
        async function editTurnstile(id, name, isActive) {
            const newName = prompt('Nome da catraca:', name);
            if (newName && newName !== name) {
                try {
                    const response = await fetch(`/api/admin/turnstiles/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ name: newName })
                    });

                    if (response.ok) {
                        alert('Catraca atualizada com sucesso!');
                        loadTurnstiles();
                    } else {
                        alert('Erro ao atualizar catraca');
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        async function toggleTurnstileStatus(id, currentStatus) {
            const action = currentStatus ? 'desativar' : 'ativar';
            if (confirm(`Tem certeza que deseja ${action} esta catraca?`)) {
                try {
                    const response = await fetch(`/api/admin/turnstiles/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ isActive: !currentStatus })
                    });

                    if (response.ok) {
                        alert(`Catraca ${currentStatus ? 'desativada' : 'ativada'} com sucesso!`);
                        loadTurnstiles();
                    } else {
                        alert(`Erro ao ${action} catraca`);
                    }
                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }
        }
        
        // Fechar modais clicando fora
        window.onclick = function(event) {
            const modals = ['turnstileModal', 'editBuildingModal', 'editResidentModal', 'qrCodesModal', 'residentsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modalId === 'residentsModal') {
                        currentBuildingIdForResidents = null;
                    }
                }
            });
        }
    </script>
</body>
</html>